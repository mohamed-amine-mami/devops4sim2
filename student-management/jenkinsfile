pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = "docker.io"
        DOCKER_IMAGE_NAME = "r3aad/devopsproject"
        DOCKER_IMAGE_TAG = "${BUILD_NUMBER}"
        GIT_BRANCH = "main"
        MAVEN_OPTS = "-Dhttp.connectionManager.timeout=60000 -Dhttp.socket.timeout=60000 -Dmaven.wagon.http.retryHandler.count=5"
        JENKINS_HEARTBEAT = "-Dorg.jenkinsci.plugins.durabletask.BourneShellScript.HEARTBEAT_CHECK_INTERVAL=300"
    }

    tools {
        maven 'Maven-3'
        jdk 'JDK-17'
    }

    stages {
        stage('üîç V√©rification de l\'environnement') {
            steps {
                script {
                    echo "=== V√©rification Maven et Java ==="
                    sh 'mvn --version'
                    sh 'java -version'
                    sh 'docker --version'
                }
            }
        }

        stage('üì• R√©cup√©ration du code') {
            steps {
                echo ">>> R√©cup√©ration du code depuis ${GIT_BRANCH}..."
                git branch: "${GIT_BRANCH}",
                    url: 'https://github.com/mohamed-amine-mami/devops4sim2.git'
            }
        }

        stage('üìö Cache des d√©pendances') {
            steps {
                echo ">>> Pr√©-t√©l√©chargement des d√©pendances en cache..."
                sh '''
                    mvn dependency:go-offline -q \
                      -Dhttp.connectionManager.timeout=60000 \
                      -Dhttp.socket.timeout=60000 \
                      -Dmaven.wagon.http.retryHandler.count=5
                '''
            }
        }

        stage('üß™ Tests unitaires') {
            steps {
                echo ">>> Lancement des tests Maven..."
                sh '''
                    mvn clean test \
                      -Dhttp.connectionManager.timeout=60000 \
                      -Dhttp.socket.timeout=60000 \
                      -Dmaven.wagon.http.retryHandler.count=5
                '''
            }
            post {
                always {
                    junit testResults: 'target/surefire-reports/*.xml',
                          allowEmptyResults: true
                    echo "‚úÖ R√©sultats de tests publi√©s"
                }
            }
        }

        stage('üì¶ Build Maven (Package)') {
            steps {
                echo ">>> Compilation et cr√©ation du JAR..."
                sh '''
                    mvn clean package -DskipTests \
                      -Dhttp.connectionManager.timeout=60000 \
                      -Dhttp.socket.timeout=60000 \
                      -Dmaven.wagon.http.retryHandler.count=5
                '''
            }
        }

        stage('üìö Archivage du livrable') {
            steps {
                echo ">>> Archivage du JAR..."
                archiveArtifacts artifacts: 'target/*.jar',
                                  fingerprint: true,
                                  allowEmptyArchive: false
            }
        }

        stage('üê≥ Build Image Docker') {
            steps {
                script {
                    echo ">>> V√©rification de Docker..."
                    sh 'docker --version'

                    echo ">>> Construction de l'image Docker..."
                    sh '''
                        docker build \
                          --tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
                          --tag ${DOCKER_IMAGE_NAME}:latest \
                          -f Dockerfile .
                    '''
                }
            }
        }

        stage('üìã Liste Images Docker') {
            steps {
                script {
                    echo ">>> Images cr√©√©es..."
                    sh 'docker images | grep ${DOCKER_IMAGE_NAME}'
                }
            }
        }

        stage('‚úÖ Test Image Docker') {
            steps {
                script {
                    echo ">>> Inspect de l'image..."
                    sh 'docker inspect ${DOCKER_IMAGE_NAME}:latest | head -20'
                }
            }
        }
    }

    post {
        success {
            echo "üéâ BUILD SUCCESS ‚úÖ"
            echo "Image Docker cr√©√©e : ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
            echo "Commande pour lancer : docker run -p 8080:8080 ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
        }
        failure {
            echo "‚ùå BUILD FAILED"
            echo "Consulte la console compl√®te pour les d√©tails"
        }
        always {
            echo "Nettoyage..."
            cleanWs()
        }
    }
}